<div class="row">
  <h2 class="col-9">myTOA</h2>
  <div class="col-3">
    <button mdc-button primary (click)="signOut()">{{ 'pages.account.logout' | translate }}</button>
  </div>
</div>

<div class="w-100 align-items-center text-center" *ngIf="user && user">
  <div *ngIf="!user.photoURL && user.displayName" class="profile-image">{{ user.displayName.substring(0, 1) }}</div>
  <img *ngIf="user.photoURL " class="profile-image" [src]="user.photoURL" height="100" />
  <div class="profile-name">{{ 'drawer.mytoa.hello' | translate: {'name': user.displayName || 'User' } }}</div>
  <div class="profile-detail">{{ ('pages.account.level' | translate: {'level': user.level }) + (user.team ? ' â‹… #' + user.team : '')}}</div>
</div>

<div class="mt-5 m-2" *ngIf="user && user">

  <div class="w-100 m-2" *ngIf="!emailVerified">
    <div class="outline-card p-3" style="border: 2px solid #F89808!important;">
      <div mdcHeadline5 class="black">{{ 'pages.account.no_verify' | translate }}</div>
      <div mdcSubtitle1 class="mt-1">{{ 'pages.account.why_verify' | translate }}</div>
      <button mdc-button primary (click)="sendEmailVerification()">
        {{ 'general.verify' | translate }}
      </button>
    </div>
  </div>

  <mdc-tab-bar #tabs [activeTabIndex]="activeTab" [class.d-none]="user.adminEvents.length === 0 && user.level < 6" class="mb-3">
    <mdc-tab-scroller>
      <mdc-tab (click)="changeUrlNoRoute('')" style="text-transform: initial" label="myTOA"></mdc-tab>
      <mdc-tab (click)="changeUrlNoRoute('events')" [label]="'pages.account.manage_events' | translate" [class.d-none]="user.adminEvents.length === 0"></mdc-tab>
      <mdc-tab (click)="changeUrlNoRoute('new-event')" [label]="'pages.account.create_event_card.title' | translate" [class.d-none]="user.level < 6"></mdc-tab>
      <mdc-tab (click)="changeUrlNoRoute('users')" label="Users" [class.d-none]="user.level < 6"></mdc-tab>
      <mdc-tab (click)="changeUrlNoRoute('cache')" [label]="'pages.account.dump_cache.title' | translate" [class.d-none]="user.level < 6"></mdc-tab>
    </mdc-tab-scroller>
  </mdc-tab-bar>

  <div *ngIf="tabs.activeTabIndex === 0" class="row">
    <div class="col-md-7 col-12 mb-3">
      <div class="outline-card p-3">
        <div class="row">
          <div class="col-md-6 col-12">
            <div mdcHeadline5 class="black mt-3">{{ "general.teams" | translate }}</div>
            <mdc-list *ngIf="teams">
              <toa-team-item *ngFor="let team of teams" [team]="team"></toa-team-item>
            </mdc-list>
            <p *ngIf="teams && teams.length === 0">{{ "no_data.teams" | translate }}</p>
          </div>
          <div class="col-md-6 col-12">
            <div mdcHeadline5 class="black mt-3">{{ "general.events" | translate }}</div>
            <mdc-list *ngIf="events">
              <toa-event-item *ngFor="let event of events" [event]="event"></toa-event-item>
            </mdc-list>
            <p *ngIf="events && events.length === 0">{{ "no_data.events" | translate }}</p>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-5 col-12 ps-md-3">
      <div class="outline-card space-between p-3" *ngIf="user.apiKey">
        <div>
          <div mdcHeadline5 class="black mt-3">{{ 'pages.account.api_card.title' | translate }}</div>
          <div mdcSubtitle1 class="mt-1">{{ 'pages.account.api_card.your_key' | translate }}</div>
          <code dir="ltr">{{ user.apiKey || 'Not found' }}</code>
          <div mdcSubtitle1 class="mt-2">{{ 'pages.account.api_card.docs' | translate }}
            <a href="https://orange-alliance.github.io/TOA-API" target="_blank" (click)="this.sendAnalytic('leaving', '/account', 'api docs');">{{ 'general.here' | translate }}</a>.
          </div>
        </div>
        <img class="server-illustration" src="../../../assets/imgs/server_illustration.svg" />
      </div>
      <div class="outline-card space-between p-3" *ngIf="!user.apiKey">
        <div>
          <div mdcHeadline5 class="black mt-3">{{ 'pages.account.api_card.title' | translate }}</div>
          <div *ngIf="!generatingApiKey">
            <div mdcSubtitle1 class="mt-1">{{ 'pages.account.api_card.no_key' | translate }}</div>
            <button mdc-button primary [disabled]="!emailVerified" (click)="generateApiKey()">{{ 'pages.account.api_card.generate_key' | translate }}</button>
          </div>
          <div *ngIf="generatingApiKey">
            <div mdcSubtitle1 class="mt-1">{{ 'pages.account.api_card.generating_key' | translate }}</div>
            <mdc-linear-progress></mdc-linear-progress>
          </div>
        </div>
        <img class="server-illustration" src="../../../assets/imgs/server_illustration.svg" />
      </div>

      <div class="outline-card p-3 mt-3" *ngIf="emailVerified">
        <div mdcHeadline5 class="black p-3">{{ 'pages.account.account_settings' | translate }}</div>
        <mdc-list disableRipple>
          <mdc-list-item (click)="sendPasswordResetEmail()">
            <mdc-icon mdcListItemGraphic svgIcon="lock-reset"></mdc-icon>
            {{ 'pages.account.reset_password' | translate }}
          </mdc-list-item>

          <mdc-list-item (click)="user.googleLinked ? unlinkProvider(googleProvider) : linkProvider(googleProvider)">
            <mdc-icon mdcListItemGraphic svgIcon="google"></mdc-icon>
            {{ (user.googleLinked ? 'pages.account.unlink_account' : 'pages.account.link_account') | translate: {name: 'Google'} }}
          </mdc-list-item>

          <mdc-list-item (click)="user.githubLinked ? unlinkProvider(githubProvider) : linkProvider(githubProvider)">
            <mdc-icon mdcListItemGraphic svgIcon="github-circle"></mdc-icon>
            {{ (user.githubLinked ? 'pages.account.unlink_account' : 'pages.account.link_account') | translate: {name: 'GitHub'} }}
          </mdc-list-item>

          <mdc-list-item (click)="user.phoneLinked ? unlinkProvider(phoneProvider) : renderCaptcha()">
            <mdc-icon mdcListItemGraphic svgIcon="phone"></mdc-icon>
            {{ (user.phoneLinked ? 'pages.account.unlink_phone' : 'pages.account.link_phone') | translate }}
          </mdc-list-item>
        </mdc-list>
        <!-- For phone auth, this has to be here -->
        <div id="recaptcha" *ngIf="showCaptcha"></div>
        <mdc-list disableRipple twoLine [interactive]="false">
          <mdc-list-item>
            <mdc-list-item-text [secondaryText]="'pages.account.last_signin' | translate">{{ user.metadata.lastSignInTime | date: 'MMM d yyyy, h:mm a' }}</mdc-list-item-text>
          </mdc-list-item>
        </mdc-list>
      </div>
    </div>
  </div>

  <div *ngIf="tabs.activeTabIndex === 1 && user.adminEvents.length > 0" class="w-100">
    <div class="outline-card p-0">
        <div mdcHeadline5 class="black p-3">{{ 'pages.account.datasync_card.title' | translate }}</div>
        <div class="table-responsive">
          <table class="table table-striped mb-0" dir="ltr">
            <thead>
            <tr>
              <th scope="col">Event Key</th>
              <th scope="col">API Key</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let eventKey of user.adminEvents">
              <td><code style="white-space:nowrap">{{ eventKey }}</code></td>
              <td *ngIf="adminEvents[eventKey]"><code style="white-space:nowrap">{{ adminEvents[eventKey] }}</code></td>
              <td *ngIf="!adminEvents[eventKey] && !generatingEventApiKey"><button mdc-button (click)="generateEventApiKey(eventKey)">{{ 'pages.account.api_card.generate_key' | translate }}</button></td>
              <td *ngIf="!adminEvents[eventKey] && generatingEventApiKey"><mdc-linear-progress></mdc-linear-progress></td>
            </tr>
            </tbody>
          </table>
        </div>

        <div mdcSubtitle1 class="p-3">{{ 'pages.account.datasync_card.docs' | translate }}
          <a href="https://github.com/orange-alliance/TOA-DataSync/wiki/DataSync-Documentation" target="_blank" (click)="this.sendAnalytic('leaving', '/account', 'datasync docs');">{{ 'general.here' | translate }}</a>.
        </div>
      </div>
  </div>

  <div *ngIf="tabs.activeTabIndex === 2 && user.level >= 6">
    <div class="outline-card">
      <div mdcHeadline5 class="black pb-4">{{ 'pages.account.create_event_card.title' | translate }}</div>
      <div class="row edit-event">
        <div class="col-md-6 col-12 mb-3">
          <mdc-text-field #event_name dense [label]="'pages.event.subpages.admin.update_info_card.event_name' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="rename-box"></mdc-icon>
          </mdc-text-field>
          <mdc-select *ngIf="currentSeason"  [placeholder]="'pages.account.create_event_card.season' | translate" (selectionChange)="onSeasonChange($event)" class="w-100">
            <option disabled></option>
            <option *ngFor="let season of seasons" [value]="season.seasonKey">
              20{{ season.seasonKey.substring(0, 2) }}/{{ season.seasonKey.substring(2, 4) }} - {{ season.description }}
            </option>
          </mdc-select>
          <mdc-select *ngIf="currentRegion"  [placeholder]="'pages.account.create_event_card.region' | translate" (selectionChange)="onRegionChange($event)" class="w-100">
            <option disabled></option>
            <option *ngFor="let region of regions" [value]="region.regionKey">
              {{ region.description ? region.regionKey + " - " + region.description : region.regionKey }}
            </option>
          </mdc-select>
          <mdc-text-field #website dense [label]="'pages.event.subpages.admin.update_info_card.website' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="earth"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #start_date dense type="date" [label]="'pages.event.subpages.admin.update_info_card.start_date' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="calendar"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #end_date dense type="date" [label]="'pages.event.subpages.admin.update_info_card.end_date' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="calendar"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #division_name *ngIf="dual_division.checked" dense [label]="'pages.account.create_event_card.division_number' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading>create</mdc-icon>
          </mdc-text-field>
          <mdc-text-field #number_fields *ngIf="advanced.checked" dense [label]="'pages.account.create_event_card.number_fields' | translate" [value]="2" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="soccer-field"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #number_alliances *ngIf="advanced.checked" dense [label]="'pages.account.create_event_card.number_alliances' | translate" [value]="4"  class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="human-handsup"></mdc-icon>
          </mdc-text-field>
          <mdc-checkbox #dual_division (click)="resetDualDivision()" ></mdc-checkbox>
          <label>{{'pages.account.create_event_card.dual_division' | translate}}</label>
          <mdc-checkbox #advanced (click)="resetAdvanced()"></mdc-checkbox>
          <label>{{'pages.account.create_event_card.advanced' | translate}}</label>
        </div>
        <div class="col-md-6 col-12 ps-md-3">
          <mdc-text-field #event_id dense [label]="'pages.account.create_event_card.event_id' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="key"></mdc-icon>
          </mdc-text-field>
          <mdc-select *ngIf="currentEventType"  [placeholder]="'pages.account.create_event_card.event_type' | translate" (selectionChange)="onEventTypeChange($event)" class="w-100">
            <option disabled></option>
            <option *ngFor="let eventType of eventTypes" [value]="eventType.eventTypeKey">
              {{ eventType.eventTypeKey }} - {{ eventType.description }}
            </option>
          </mdc-select>
          <mdc-text-field #venue dense [label]="'pages.event.subpages.admin.update_info_card.venue' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="spotlight"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #city dense [label]="'pages.event.subpages.admin.update_info_card.city' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="city-variant-outline"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #state dense [label]="'pages.event.subpages.admin.update_info_card.state' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="map-marker-outline"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #country dense [label]="'pages.event.subpages.admin.update_info_card.country' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading svgIcon="globe-model"></mdc-icon>
          </mdc-text-field>
          <mdc-text-field #division_number *ngIf="dual_division.checked" dense [label]="'pages.account.create_event_card.division_number' | translate" [value]="0" class="w-100">
            <mdc-icon mdcTextFieldIcon leading>device_hub</mdc-icon>
          </mdc-text-field>
          <mdc-text-field #advancement_spots *ngIf="advanced.checked" dense [label]="'pages.account.create_event_card.advancement_spots' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading>filter_list</mdc-icon>
          </mdc-text-field>
          <mdc-text-field #advancement_event *ngIf="advanced.checked" dense [label]="'pages.account.create_event_card.advancement_event' | translate" class="w-100">
            <mdc-icon mdcTextFieldIcon leading>call_made</mdc-icon>
          </mdc-text-field>
        </div>
        <button mdc-button primary (click)="createEvent()" class="mt-2">{{ 'pages.account.create_event_card.create' | translate }}</button>
      </div>
    </div>
  </div>

  <div *ngIf="tabs.activeTabIndex === 3 && user.level >= 6" class="row">
    <div class="outline-card col-12">
      <div mdcHeadline5 class="black pt-2 pb-2">{{ users.length > 0 ? users.length + ' Users' : 'Loading...' }}</div>
        <mdc-list twoLine>
          <mdc-list-item *ngFor="let listUser of users" (click)="selectUser(listUser)" data-toggle="modal" data-target="#userdialog">
            <mdc-list-item-text [secondaryText]="listUser.uid"><b>{{ listUser.displayName || ''}}</b>{{ listUser.displayName ? ' - '  + listUser.email : listUser.email }}</mdc-list-item-text>
            <div mdcListItemMeta class="d-none d-sm-block">
              <mdc-icon [class.d-none]="!listUser.email_linked" svgIcon="email" class="ms-2"></mdc-icon>
              <mdc-icon [class.d-none]="!listUser.phone_linked" svgIcon="phone" class="ms-2"></mdc-icon>
              <mdc-icon [class.d-none]="!listUser.google_linked" svgIcon="google" class="ms-2"></mdc-icon>
              <mdc-icon [class.d-none]="!listUser.github_linked" svgIcon="github-circle" class="ms-2"></mdc-icon>
            </div>
          </mdc-list-item>
        </mdc-list>
    </div>
  </div>

  <div *ngIf="tabs.activeTabIndex === 4 && user.level >= 6" class="row">
    <div class="outline-card col-12 mb-2">
      <div mdcHeadline5 class="black pt-2 pb-2">{{ 'pages.account.dump_cache.general' | translate }}</div>
      <mdc-radio-group class="cache-radio-group" [(ngModel)]="generalCache">
        <mdc-form-field>
          <mdc-radio value="/event"></mdc-radio> Events List
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/team"></mdc-radio> Teams List
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/streams"></mdc-radio> Streams
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/web/announcements"></mdc-radio> Announcements
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/high-scores"></mdc-radio> High Scores
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/event-types"></mdc-radio> Event Types
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/seasons"></mdc-radio> Seasons
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/regions"></mdc-radio> Regions
        </mdc-form-field>
        <mdc-form-field>
          <mdc-radio value="/leagues"></mdc-radio> Leagues
        </mdc-form-field>
      </mdc-radio-group>

      <button mdc-button primary class="test-button" (click)="dumpGeneralCache()" class="mt-2">{{ 'pages.account.dump_cache.dump' | translate }}</button>
    </div>
    <div class="col-md-4 col-12 mb-2 pe-md-2">
      <div class="outline-card">
        <div mdcHeadline5 class="black pt-2 pb-2">{{ 'general.event' | translate }}</div>
        <mdc-text-field #eventCache dense label="Event Key" class="w-100">
          <mdc-icon mdcTextFieldIcon leading svgIcon="calendar-outline"></mdc-icon>
        </mdc-text-field>
        <button mdc-button primary (click)="dumpEventCache()" class="mt-2">{{ 'pages.account.dump_cache.dump' | translate }}</button>
      </div>
    </div>
    <div class="col-md-4 col-12 mb-2 pe-md-2">
      <div class="outline-card">
        <div mdcHeadline5 class="black pt-2 pb-2">{{ 'general.team' | translate }}</div>
        <mdc-text-field #teamCache dense label="Team Key" class="w-100">
          <mdc-icon mdcTextFieldIcon leading svgIcon="account-group-outline"></mdc-icon>
        </mdc-text-field>
        <button mdc-button primary (click)="dumpTeamCache()" class="mt-2">{{ 'pages.account.dump_cache.dump' | translate }}</button>
      </div>
    </div>
    <div class="col-md-4 col-12 mb-2">
      <div class="outline-card">
        <div mdcHeadline5 class="black pt-2 pb-2">{{ 'general.match' | translate }}</div>
        <mdc-text-field #matchCache dense label="Match Key" class="w-100">
          <mdc-icon mdcTextFieldIcon leading svgIcon="gamepad-variant"></mdc-icon>
        </mdc-text-field>
        <button mdc-button primary (click)="dumpMatchCache()" class="mt-2">{{ 'pages.account.dump_cache.dump' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<!-- User Dialog -->
<div class="modal fade" id="userdialog" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered user-modal" role="document">
    <div mdcDialogSurface class="modal-content border-0" *ngIf="selectedUser">
      <mdc-dialog-title>User Details</mdc-dialog-title>
      <mdc-dialog-content>
        <mdc-list disableRipple [interactive]="false" border >
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="account-outline"></mdc-icon>
            <b>Name:</b>&nbsp;{{ selectedUser.displayName }}</mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="phone-outline"></mdc-icon>
            <b>Phone:</b>&nbsp;{{ selectedUser.phoneNumber || '' }}
          </mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="pirate"></mdc-icon>
            <b>Level:</b>&nbsp;{{ selectedUser.level }}
          </mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="email-outline"></mdc-icon>
            <b>Email:</b>&nbsp;{{ selectedUser.email }}
          </mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="account-group-outline"></mdc-icon>
            <b>Favorite Teams:</b>&nbsp;{{ selectedUser.favoriteTeams.join(', ') }}
          </mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="calendar-outline"></mdc-icon>
            <b>Favorite Events:</b>&nbsp;{{ selectedUser.favoriteEvents.join(', ') }}</mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="wrench-outline"></mdc-icon>
            <b>Event Admin:</b>&nbsp;{{ selectedUser.adminEvents.join(', ') }}</mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="key-outline"></mdc-icon>
            <b>API Key:</b>&nbsp;<code>{{ selectedUser.apiKey || '' }}</code>
          </mdc-list-item>
          <mdc-list-item>
            <mdc-icon mdcListItemGraphic svgIcon="shield-key-outline"></mdc-icon>
            <b>UID:</b>&nbsp;<code>{{ selectedUser.uid }}</code>
          </mdc-list-item>
        </mdc-list>
      </mdc-dialog-content>
      <mdc-dialog-actions>
        <button mdcDialogButton data-dismiss="modal">Close</button>
      </mdc-dialog-actions>
    </div>
  </div>
</div>
